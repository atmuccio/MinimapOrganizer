name: Package and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Package and Release
        uses: BigWigsMods/packager@v2
        env:
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}
          # WAGO_API_TOKEN: ${{ secrets.WAGO_API_TOKEN }}
          # WOWI_API_TOKEN: ${{ secrets.WOWI_API_TOKEN }}

      # NOTE: CurseForge does not support updating project descriptions via API.
      # This is a requested feature but not yet implemented.
      # Descriptions must be updated manually at: https://authors.curseforge.com/
      # See: https://curseforge-ideas.overwolf.com/?category=6844088570764767168

  notify:
    needs: release
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Notify Discord
        run: |
          if [ "${{ needs.release.result }}" = "success" ]; then
            COLOR=3066993
            TITLE="Release Published"
            DESCRIPTION="MinimapOrganizer ${{ github.ref_name }} has been released."
          else
            COLOR=15158332
            TITLE="Release Failed"
            DESCRIPTION="MinimapOrganizer ${{ github.ref_name }} release failed. Check the workflow logs."
          fi

          COMMIT_MSG=$(git log -1 --pretty=%s)

          curl -s -H "Content-Type: application/json" -d "{
            \"embeds\": [{
              \"title\": \"$TITLE\",
              \"description\": \"$DESCRIPTION\",
              \"color\": $COLOR,
              \"fields\": [
                {\"name\": \"Version\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
                {\"name\": \"Triggered by\", \"value\": \"${{ github.actor }}\", \"inline\": true},
                {\"name\": \"Commit\", \"value\": \"[\`${GITHUB_SHA::7}\`](https://github.com/${{ github.repository }}/commit/${GITHUB_SHA}) $COMMIT_MSG\", \"inline\": false}
              ],
              \"url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }]
          }" "${{ secrets.DISCORD_WEBHOOK }}"